name: Frontend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'apps/web-frontend/**'          #  [ìˆ˜ì • 1] í”„ë¡ íŠ¸ì—”ë“œ ê²½ë¡œë¡œ ë³€ê²½
      - '.github/workflows/frontend-ci.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Docker Hub ë¡œê·¸ì¸
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 3. ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
    - name: Set image tag
      id: vars
      run: echo "TAG=$(date +%s)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ./apps/web-frontend      # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ê²½ë¡œ (ì •ìƒ)
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/web-frontend:${{ steps.vars.outputs.TAG }}

    # 5. k8s YAML íŒŒì¼ ìˆ˜ì • (ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸)
    - name: Update Kubernetes Manifest
      run: |
        cd k8s
        # ğŸ‘ˆ [ìˆ˜ì • 2] product-serviceë¥¼ web-frontendë¡œ ë³€ê²½!
        sed -i "s|image: .*|image: ${{ secrets.DOCKER_USERNAME }}/web-frontend:${{ steps.vars.outputs.TAG }}|g" frontend.yaml
        
        # ë³€ê²½ í™•ì¸
        cat frontend.yaml

    # 6. ë³€ê²½ëœ YAML íŒŒì¼ì„ GitHubì— ë‹¤ì‹œ ì»¤ë°‹ & í‘¸ì‹œ
    - name: Commit and Push changes
      run: |
        git config --global user.email "${{ secrets.DOCKER_USERNAME }}@users.noreply.github.com"
        git config --global user.name "GitHub Actions"
        
        git add k8s/frontend.yaml
        git commit -m "Update frontend image tag to ${{ steps.vars.outputs.TAG }}"
        git pull origin main --rebase
        git push