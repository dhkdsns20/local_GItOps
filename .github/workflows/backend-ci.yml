name: Backend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'services/product-service/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Docker Hub 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. 이미지 태그 생성
      - name: Set image tag
        id: vars
        run: echo "TAG=$(date +%s)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      # 4. Docker 이미지 빌드 및 푸시
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./services/product-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/product-service:${{ steps.vars.outputs.TAG }}

      # 5. k8s YAML 파일 수정
      - name: Update Kubernetes Manifest
        run: |
          cd k8s
          sed -i "s|image: .*|image: ${{ secrets.DOCKER_USERNAME }}/product-service:${{ steps.vars.outputs.TAG }}|g" backend.yaml
          cat backend.yaml

      # 6. 변경 내용 GitHub에 반영 (경로 수정됨)
      - name: Commit and Push changes
        run: |
          git config --global user.email "${{ secrets.DOCKER_USERNAME }}@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          
          git add k8s/backend.yaml
          git commit -m "Update backend image tag to ${{ steps.vars.outputs.TAG }}"
          git push